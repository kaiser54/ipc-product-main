<template>
  <div class="container" style="width: 100%; ">
    <LoaderComponent v-if="loading" />
    <div class="empty" v-else-if="filteredProducts.length === 0">
      <EmptySystem :header="header" :snippet="snippet">

        <template v-slot:svg>
          <svg xmlns="http://www.w3.org/2000/svg" width="106" height="86" viewBox="0 0 106 86" fill="none">
            <path
              d="M3.63513 51.9548L38.3609 84.2037C38.8907 84.6952 39.5207 85.058 40.2032 85.268L54.8027 63.4474L5.0001 17.7588L0.714268 43.3879C0.184502 46.5522 1.28221 49.769 3.63513 51.9548Z"
              fill="#BDC0CE" />
            <path
              d="M40.2032 85.2681C40.7091 85.4256 41.2485 85.4972 41.7925 85.4781L79.6969 83.9938C82.761 83.8745 85.5768 82.2948 87.2711 79.7462L98.8066 62.4023L54.8028 63.4476L40.2032 85.2681Z"
              fill="#E5E7EF" />
            <path
              d="M0.523762 13.6545L5.00051 17.7589L54.8031 63.4475L57.8672 56.1167L41.3634 41.6365L27.5942 29.5522L29.1979 32.1055C30.3099 32.3871 31.126 33.3941 31.126 34.5921C31.126 34.7639 31.1117 34.9309 31.0783 35.0932C30.8444 36.2721 29.8088 37.155 28.5631 37.155C27.1456 37.155 25.9954 36.0096 25.9954 34.5921C25.9954 34.406 26.0145 34.2294 26.0527 34.0528L17.8724 21.0234H17.8676L10.427 14.4849H10.4223L2.49487 7.52637L0.523762 13.6545Z"
              fill="#E5E7EF" />
            <path
              d="M54.8034 63.4474L98.8072 62.4022L103.403 62.2924L105.475 54.6943L94.7696 55.0141L57.8674 56.1166L54.8034 63.4474Z"
              fill="#F4F5F8" />
            <path
              d="M49.0046 15.2957L94.7696 55.0137L105.475 54.6939L76.5237 29.5373V29.5325L66.9116 21.1852L66.9068 21.1804L66.902 21.1708L51.558 7.84082L49.0046 15.2957Z"
              fill="#7E8494" />
            <path d="M2.49567 7.52637L10.4231 14.4849H10.4278L13.8164 14.5565L9.4017 7.52637H2.49567Z" fill="#565C69" />
            <path d="M10.4266 14.4844L17.8672 21.0181L13.8152 14.556L10.4266 14.4844Z" fill="#7E8494" />
            <path
              d="M6.9901 3.6894L7.04737 3.78008L9.40029 7.52661L13.815 14.5567L17.867 21.0189H17.8717L26.0521 34.053L26.8587 35.3369C26.8587 35.3369 26.8586 35.3464 26.8634 35.3464L27.1593 35.8093C27.1593 35.8093 27.1593 35.8189 27.1689 35.8237C27.5077 36.2103 28.0041 36.4537 28.5625 36.4537C29.5886 36.4537 30.4238 35.6185 30.4238 34.5923C30.4238 34.2726 30.3427 33.9671 30.1995 33.7046C30.1709 33.6521 30.1375 33.5996 30.1041 33.5519L29.1973 32.1058L27.5936 29.5524L18.2345 14.6474L13.7625 7.52661L11.4287 3.80394L9.04234 0.00491546C7.14759 -0.00462985 5.98307 2.08102 6.9901 3.6894Z"
              fill="#303237" />
            <path d="M13.762 7.52637L18.234 14.6472L49.0033 15.2962L51.5566 7.84136L51.1939 7.52637H13.762Z"
              fill="#565C69" />
            <path
              d="M9.0429 0.00477731L11.4292 3.8038L51.7772 4.04244C54.5072 4.05676 57.0415 5.46946 58.4971 7.77942L66.9018 21.1715V21.181H66.9113L76.5234 29.5284L60.5446 4.08539L60.4873 3.99471C59.0364 1.68475 56.5069 0.276818 53.777 0.257727L9.0429 0V0.00477731Z"
              fill="#565C69" />
            <path
              d="M25.9964 34.592C25.9964 36.0095 27.1465 37.1549 28.564 37.1549C29.8097 37.1549 30.8454 36.272 31.0792 35.0979C31.1126 34.9309 31.127 34.7638 31.127 34.592C31.127 33.3941 30.3108 32.3871 29.1988 32.1055L30.1056 33.5516C30.139 33.5993 30.1724 33.6518 30.2011 33.7043C30.3442 33.9668 30.4254 34.2723 30.4254 34.592C30.4254 35.6181 29.5901 36.4534 28.564 36.4534C28.0056 36.4534 27.5093 36.2099 27.1704 35.8234C27.1656 35.8186 27.1609 35.8138 27.1609 35.809C27.0368 35.6706 26.9413 35.5179 26.865 35.3461C26.8602 35.3461 26.8602 35.3413 26.8602 35.3366L26.0536 34.0527C26.0154 34.2293 25.9964 34.4059 25.9964 34.592Z"
              fill="#BDC0CE" />
            <path d="M41.3635 41.6362L57.8674 56.1164L94.7695 55.0139L49.0046 15.2959L41.3635 41.6362Z" fill="#BDC0CE" />
            <path d="M18.2346 14.6475L27.5938 29.5525L41.3629 41.6368L49.0039 15.2965L18.2346 14.6475Z" fill="#7E8494" />
          </svg>
        </template>
      </EmptySystem>
    </div>
    <div class="nuxt-page" v-else>
      <promptAlert @openMail="handleOpenMail" v-if="!verifiedEmail" />
      <div class="page-title">
        <h2 class="h2-medium header-text">Market</h2>
      </div>
      <section class="market-product">
        <div class="product-top-wrap">
          <ProductCard v-for="product in filteredProducts" :key="product.id" :product="product" :inCart="inCart" />

        </div>
      </section>
      <transition name="modal-fade">
        <popupModal v-if="checkMail" :animate="animate" title="Check your email address"
          snippet="We have sent a secured reset link to your email. Click on the link to verify your email."
          buttonText="Resend link" buttonText2="Got it" buttonClass="neutral-btn" buttonClass2="primary-btn"
          @closeModal="handleOpenMail" @closeModalBG="handleOpenMail" />
      </transition>
      <ModalWelcome v-if="showModal" @cancelModal="removeModal()" @complete-flow="removeModal()" />

    </div>

  </div>
</template>

<script>
import { mapState, mapActions, mapGetters } from "vuex";
import ProductCard from "@/components/productcard";
export default {
  layout: "dashboardview",
  head() {
    return {
      title: this.pageTitle,
    };
  },
  components: {
    ProductCard,
  },
  data() {
    return {
      // api: process.env.BASE_URL,
      pageTitle: "IPC | Market",
      checkMail: false,
      inCart: false,
      animate: null,
      showModal: false,
      header: "Search not found",
      snippet: "This product is not currently available, search for another item",
      verifiedEmail: false,
      showVerifiedModal: true
    };
  },
  mounted() {
    const userData = localStorage.getItem("user");
    if (userData) {
      this.user = JSON.parse(userData);
      console.log("User data in localStorage:", JSON.parse(userData));
      console.log("User:", this.user.verified);
      localStorage.setItem("userId", this.user._id);
      localStorage.setItem("userEmail", this.user.email);

    } else {
      console.log("User data not found in localStorage.");
    }
    this.getAllProduct()
    this.getUserDetails()
  },
  computed: {
    ...mapState("product", ["loading", "error"]),
    ...mapGetters("product", ["getProductsBySearch"]),
    filteredProducts() {
      return this.getProductsBySearch; // Use the searchQuery here
    },
  },
  methods: {
    ...mapActions("product", ["fetchAllProducts"]),
    ...mapActions("cart", ["fetchCartItemsByUserID", "fetchFavouriteByUserID"]),
    checkScreenSize() {
      this.animate =
        window.innerWidth <= 950 ? "animate__slideInUp" : "animate__zoomIn";
    },
    async getUserDetails() {
      try {
        const response = await this.$axios.get(`/business-customers/${this.user._id}`)
        this.userProfile = response.data.data.customer
        console.log("user-profile:", this.userProfile)
        console.log("user-profile-status:", this.userProfile.verified)
        this.userProfileStatus = response.data.data.customer.verified
        this.verifiedEmail = this.userProfileStatus
      } catch (error) {
        console.error("Error fetching data", error);
        return { responseData: null };
      }
    },
    async handleOpenMail() {
      this.checkMail = !this.checkMail;
      try {
        const userEmail = localStorage.getItem('userEmail');
        if (!userEmail) {
          throw new Error('User email not found in localStorage.');
        }
        const response = await this.$axios.post('/business-customers/send-verification-email', {
          email: userEmail,
        });
        console.log('Email sent successfully:', response.data);
        console.log(userEmail)

        return { userEmail };
      } catch (error) {
        console.error('Error sending email:', error);
        return { userEmail: null };
      }
    },
    async getAllProduct() {
      // set welcome modal to show on condition that a user is new or not
      this.showModal = localStorage.getItem('welcomeFlow') !== 'complete'
      await this.fetchAllProducts(); // Fetch all products when the component is mounted
      this.checkScreenSize();
      window.addEventListener("resize", this.checkScreenSize);

    },
    welcomeUser() {
      const welcome = localStorage.getItem("welcomeFlow");
      if (!welcome) {
        localStorage.setItem("welcomeFlow", "incomplete");
      }
    },
    clear() {
      localStorage.removeItem("welcomeFlow");
    },
    removeModal() {
      this.showModal = false;
      this.showVerifiedModal = false
      localStorage.setItem("welcomeFlow", "complete");
    },
    routeToMarket() {
      this.$router.push("/dashboard/market")
      this.showVerifiedModal = false
    },
  },

  beforeDestroy() {
    window.removeEventListener("resize", this.checkScreenSize);
  },
};
</script>



<style>
.nuxt-page {
  display: flex;
  gap: 32px;
  flex-direction: column;
  width: auto;
  height: 100%;
  min-width: 100%;
}
</style>

<style scoped>
.product-top-wrap {
  display: flex;
  flex-wrap: wrap;
  flex-direction: row;
  align-items: flex-start;
  padding: 16px;
  gap: 16px;
  width: 100%;
  /* justify-content: space-between; */
}

.empty {
  width: 360px;
  height: 210px;
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  /* border: 1px solid red; */
  text-align: center;
  margin: auto;
  margin-top: 10%;

}

@media (min-width: 950px) {
  .webskeleton {
    display: block;
  }

  .SkeletonLoader {
    display: none;
  }
}

@media (max-width: 950px) {
  .product-top-wrap {
    padding: 0;
    gap: 8px;
  }

  .webskeleton {
    display: none;
  }

  .SkeletonLoader {
    display: block;
  }
}

@media (max-width: 950px) {
  .m-20 {
    margin: 0;
    padding: 16px;
    background: var(--grey-grey6);
  }

  .page-title {
    display: none;
  }
}
</style>
